name: KRX Market Data Sync

on:
  schedule:
    # í‰ì¼ ì˜¤ì „ 9ì‹œ 30ë¶„ (KST = UTC+9, ì¦‰ UTC 00:30)
    - cron: '30 0 * * 1-5'
    # í‰ì¼ ì˜¤í›„ 4ì‹œ 30ë¶„ (KST = UTC+9, ì¦‰ UTC 07:30)
    - cron: '30 7 * * 1-5'
  
  # ìˆ˜ë™ ì‹¤í–‰ ë²„íŠ¼
  workflow_dispatch:

jobs:
  sync-market-data:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install requests supabase
      
      - name: Sync KRX Stock Data
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          DATA_GO_KR_API_KEY: ${{ secrets.DATA_GO_KR_API_KEY }}
        run: |
          echo "ğŸš€ KRX ì¢…ëª© ë°ì´í„° ë™ê¸°í™” ì‹œì‘"
          python scripts/fetch_krx_stocks.py
          
          if [ $? -eq 0 ]; then
            echo "âœ… ì¢…ëª© ë°ì´í„° ë™ê¸°í™” ì„±ê³µ"
          else
            echo "âŒ ì¢…ëª© ë°ì´í„° ë™ê¸°í™” ì‹¤íŒ¨"
            exit 1
          fi
      
      - name: Sync Market Indices
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          echo "ğŸ“Š ì‹œì¥ ì§€ìˆ˜ ë™ê¸°í™” ì‹œì‘"
          python scripts/update_indices.py
          
          if [ $? -eq 0 ]; then
            echo "âœ… ì§€ìˆ˜ ë°ì´í„° ë™ê¸°í™” ì„±ê³µ"
          else
            echo "âš ï¸ ì§€ìˆ˜ ë°ì´í„° ë™ê¸°í™” ì‹¤íŒ¨ (ê³„ì† ì§„í–‰)"
          fi
        continue-on-error: true
      
      - name: Summary
        if: always()
        run: |
          echo "========================================"
          echo "ì‘ì—… ì™„ë£Œ ì‹œê°„: $(date +'%Y-%m-%d %H:%M:%S')"
          echo "========================================"
      - name: Trigger Vercel Deploy
        if: SUCCESS()
        run: |
          curl -x POST ${{secrets.VERCEL_DEPLOY_HOOK_URL }}